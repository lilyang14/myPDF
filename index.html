<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>作品集</title>

  <!-- 推荐 favicon_io 文件夹里常见文件名，确保这些文件存在 -->
  <link rel="icon" href="favicon_io/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="favicon_io/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="favicon_io/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="favicon_io/favicon-16x16.png" />
  <link rel="manifest" href="favicon_io/site.webmanifest" />

  <style>
    :root{
      --bg:#1C1C1C;
      --overlay-bg: rgba(0,0,0,0.6);
      --image-placeholder: #2a2a2a; /* 图片加载占位背景 */
      --image-error: #4a2a2a; /* 图片加载失败背景 */
    }
    html,body{
      height:100%;
      margin:0;
      background:var(--bg);
      color:#fff;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      user-select:none; /* 禁止选中文本 */
    }

    /* 整体容器：顶部留 60px 空间 */
    .wrap{
      padding-top:60px;
      box-sizing:border-box;
      min-height:100vh;
    }

    /* 画廊容器：单列垂直排列，居中，桌面宽度 65%，最大 1200px */
    .gallery{
      width:100%;
      max-width:1200px;
      margin:0 auto;
      box-sizing:border-box;
      /* 桌面占比 65%：通过媒体查询实现响应 */
    }

    /* 图片容器：用于处理加载状态 */
    .image-container {
      position: relative;
      width: 100%;
      background: var(--image-placeholder);
      overflow: hidden;
    }

    /* 图片样式：宽度按容器 100%，高按比例自适应；添加过渡效果 */
    .gallery img{
      width:100%;
      height:auto;
      display:block;
      margin:0;
      padding:0;
      border:0;
      -webkit-user-drag:none; /* 禁止拖拽 */
      user-drag:none;
      opacity: 0; /* 初始透明 */
      transform: scale(0.98); /* 初始轻微缩放 */
      transition: opacity 0.6s ease-out, transform 0.6s ease-out; /* 平滑过渡 */
    }

    /* 图片加载完成状态 */
    .gallery img.loaded {
      opacity: 1;
      transform: scale(1);
    }

    /* 图片加载失败状态 */
    .gallery img.error {
      background: var(--image-error);
    }

    /* 加载指示器：轻微的背景动画 */
    .image-container::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 50%;
      height: 100%;
      background: linear-gradient(
        to right,
        rgba(255,255,255,0) 0%,
        rgba(255,255,255,0.05) 100%
      );
      animation: shimmer 1.5s infinite;
      pointer-events: none;
    }

    @keyframes shimmer {
      100% {
        left: 100%;
      }
    }

    /* 图片加载完成后隐藏加载指示器 */
    .image-container.loaded::after {
      display: none;
    }

    /* 网络异常提示覆盖层 */
    .overlay {
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background:var(--overlay-bg);
      z-index:9999;
      color:#fff;
      text-align:center;
      padding:20px;
      box-sizing:border-box;
      visibility:hidden;
      opacity:0;
      transition:opacity .18s ease, visibility .18s;
    }
    .overlay.show{ visibility:visible; opacity:1; }

    .overlay .card{
      max-width:420px;
      width:100%;
    }
    .overlay h2{
      margin:0 0 20px;
      font-weight:600;
      font-size:18px;
    }

    .reload-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:96px;
      height:36px;
      border-radius:4px;
      background: rgba(255,255,255,0.2); /* 白色 20% 透明度 */
      color:#FFFFFF;
      font-size:14px;
      border: none;
      cursor:pointer;
    }

    /* 响应式：桌面视口宽度 >= 900px 时，容器为窗口的 65% */
    @media(min-width:900px){
      .gallery{
        width:65vw;
        max-width:1200px;
      }
    }

    /* 移动端：图片已在容器 100%，viewport 会保证屏幕宽度 */
  </style>
</head>
<body>
  <div class="wrap">
    <main class="gallery" id="gallery" aria-live="polite"></main>
  </div>

  <!-- 网络异常覆盖 -->
  <div class="overlay" id="overlay" role="alertdialog" aria-hidden="true">
    <div class="card">
      <h2 id="overlay-msg">网络异常，请重新加载</h2>
      <div style="height:20px"></div>
      <div style="display:flex; justify-content:center;">
        <button class="reload-btn" id="reloadBtn" type="button">重新加载</button>
      </div>
    </div>
  </div>

  <script>
    (function(){
      // 配置
      const gallery = document.getElementById('gallery');
      const overlay = document.getElementById('overlay');
      const reloadBtn = document.getElementById('reloadBtn');

      // 尝试的最大编号上限（安全界限，避免无限尝试）
      const ABSOLUTE_MAX = 5000;

      // 当连续这个数目的索引都不存在时，认为目录扫描结束
      const CONSECUTIVE_FAILURES_TO_STOP = 6;

      // 尝试的扩展名顺序（优先 png，再 jpg/jpeg）
      const exts = ['.png', '.jpg', '.jpeg', '.webp'];

      let index = 1;
      let consecutiveFailures = 0;
      let loadedCount = 0;

      // 刷新后自动回到顶部
      window.addEventListener('load', () => window.scrollTo(0,0), {once:true});

      // 重载按钮
      reloadBtn.addEventListener('click', () => {
        location.reload();
      });

      // 当网络离线时显示 overlay
      function showOverlay(msg) {
        document.getElementById('overlay-msg').textContent = msg || '网络异常，请重新加载';
        overlay.classList.add('show');
        overlay.setAttribute('aria-hidden','false');
      }
      function hideOverlay(){
        overlay.classList.remove('show');
        overlay.setAttribute('aria-hidden','true');
      }

      // 监听在线状态变化
      window.addEventListener('offline', () => showOverlay('网络异常，请重新加载'));
      window.addEventListener('online', () => {
        // 尝试隐藏并继续加载
        hideOverlay();
        // 若之前没有加载任何图片，重试一轮
        if (loadedCount === 0) {
          // reset scanning and try again from 1
          index = 1;
          consecutiveFailures = 0;
          scanNext();
        }
      });

      // 禁用右键菜单、拖拽、复制、另存为等常规方法（无法 100% 阻止保存，但可以阻挡常见手段）
      window.addEventListener('contextmenu', e => e.preventDefault());
      window.addEventListener('dragstart', e => e.preventDefault());
      window.addEventListener('selectstart', e => e.preventDefault());
      window.addEventListener('copy', e => e.preventDefault());
      // 阻止常见快捷键（Ctrl/Cmd+S, Ctrl+U, Ctrl+Shift+I）
      window.addEventListener('keydown', function(e){
        if ((e.ctrlKey || e.metaKey) && (e.key === 's' || e.key === 'S' || e.key === 'u' || e.key === 'U')) {
          e.preventDefault();
        }
        if (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'i')) {
          e.preventDefault();
        }
      });

      // 创建图片容器和图片元素
      function createImageElement(src){
        // 创建容器用于显示加载状态
        const container = document.createElement('div');
        container.className = 'image-container';
        
        const img = document.createElement('img');
        img.src = src;
        img.alt = ''; // 仅图片展示，不显示额外文字
        img.loading = 'lazy'; // 懒加载优化，只加载可视区域图片
        img.draggable = false;
        
        // 加载完成后显示图片
        img.addEventListener('load', () => {
          img.classList.add('loaded');
          container.classList.add('loaded');
        });
        
        // 加载失败处理
        img.addEventListener('error', () => {
          img.classList.add('error');
          container.classList.add('error');
        });
        
        container.appendChild(img);
        return container;
      }

      // 检查指定路径（通过 Image 对象）是否可加载
      function testImage(path){
        return new Promise((resolve) => {
          const im = new Image();
          im.onload = () => resolve({ok:true, path});
          im.onerror = () => resolve({ok:false, path});
          // 添加时间戳避免缓存影响
          im.src = `${path}?t=${Date.now()}`;
        });
      }

      // 扫描并加载下一张图片（递归式）
      async function scanNext(){
        // 安全停止
        if (index > ABSOLUTE_MAX) return finalize();
        // 尝试所有后缀
        let found = false;
        for (let ext of exts){
          const path = `images/work${index}${ext}`;
          const res = await testImage(path);
          if (res.ok){
            // 成功：重置失败计数，插入图片（按序）
            consecutiveFailures = 0;
            loadedCount++;
            const imgContainer = createImageElement(path);
            gallery.appendChild(imgContainer);
            found = true;
            break;
          }
        }
        if (!found){
          consecutiveFailures++;
        }

        // 当没有加载过任何图片且网络不在线，直接显示网络错误
        if (loadedCount === 0 && !navigator.onLine){
          showOverlay('网络异常，请重新加载');
          return;
        }

        // 如果连续失败达到阈值，认为目录末尾，结束扫描
        if (consecutiveFailures >= CONSECUTIVE_FAILURES_TO_STOP){
          return finalize();
        }

        index++;
        // 继续下一张，使用requestAnimationFrame优化性能
        requestAnimationFrame(scanNext);
      }

      function finalize(){
        // 如果一张图片都没有加载，认为可能是网络问题或 images 文件夹位置不对，提示并保留重试按钮
        if (loadedCount === 0){
          showOverlay('网络异常，请重新加载');
        } else {
          hideOverlay();
        }
      }

      // 启动扫描
      scanNext();

    })();
  </script>
</body>
</html>
